<html>

<head>
    <title>Mail Server Tester</title>
    <link rel="stylesheet" href="bootstrap-5.2.3-dist/css/bootstrap.min.css">
    <script src="bootstrap-5.2.3-dist/js/bootstrap.min.js"></script>
    <script src="jquery-3.6.4.min/jquery-3.6.4.min.js"></script>
    <script src="functions.js"></script>
</head>

<body>
    <nav class="navbar bg-light">
        <div class="container-fluid">
            <a class="navbar-brand">
                Mail Server Tester
            </a>
        </div>
    </nav>
    <div id="content">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a name="configuration" class="tab-link nav-link active">Configuration</a>
            </li>
            <li id="send-email-tab" class="nav-item hiden">
                <a name="send-email" class="tab-link nav-link">Send Email</a>
            </li>
        </ul>
        <div id="session">
            <div class="session active-session" id="session-configuration">
                <div class="mb-3 row">
                    <label class="col-sm-2 col-form-label">Host/Port</label>
                    <div class="col-sm-10">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control config-form" id="ip-host" placeholder="Host">
                            <input style="max-width: 200px;" type="text" class="form-control config-form" id="ip-port" placeholder="Port">
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label class="col-sm-2 col-form-label">Encryption</label>
                    <div class="col-sm-10">
                        <div class="btn-group" role="group" aria-label="radio toggle button group">
                            <input type="radio" class="btn-check" name="ipcb-encryption" id="ipcb-encryption-none" value="none" checked>
                            <label class="btn btn-outline-primary" for="ipcb-encryption-none">None</label>
                            <input type="radio" class="btn-check" name="ipcb-encryption" id="ipcb-encryption-tls" value="tls">
                            <label class="btn btn-outline-primary" for="ipcb-encryption-tls">TLS</label>
                            <input type="radio" class="btn-check" name="ipcb-encryption" id="ipcb-encryption-ssl" value="ssl">
                            <label class="btn btn-outline-primary" for="ipcb-encryption-ssl">SSL</label>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label class="col-sm-2 col-form-label">Authentication</label>
                    <div class="col-sm-10">
                        <div class="form-check form-switch">
                            <input class="form-check-input cp-pointer" id="ipsw-auth" type="checkbox" role="switch">
                            <label class="form-check-label" for="ipsw-auth">Off</label>
                        </div>
                    </div>
                </div>
                <div id="auth-info" class="hiden">
                    <div class="mb-3 row">
                        <label class="col-sm-2 col-form-label">Username</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control config-form" id="ip-auth-username" placeholder="Username">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-2 col-form-label">Password</label>
                        <div class="col-sm-10">
                            <input type="password" class="form-control config-form" id="ip-auth-password" placeholder="Password">
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label class="col-sm-2 col-form-label">Send From</label>
                    <div class="col-sm-10">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control config-form" id="ip-send-from" placeholder="Email Address">
                            <input style="max-width: 200px;" type="text" class="form-control config-form" id="ip-send-from-name" placeholder="Name">
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label class="col-sm-2 col-form-label">Reply To</label>
                    <div class="col-sm-10">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control config-form" id="ip-reply-to" placeholder="Email Address">
                            <input style="max-width: 200px;" type="text" class="form-control config-form" id="ip-reply-to-name" placeholder="Name">
                        </div>
                    </div>
                </div>
                <div class="div-act-btn">
                    <button type="button" class="btn btn-secondary" id="actbtn-config-clear">Clear Config</button>
                    <button type="button" class="btn btn-primary" id="actbtn-config-done">Done</button>
                </div>
            </div>
            <div class="session" id="session-send-email">
                <div class="mb-3 row">
                    <label class="col-sm-2 col-form-label">Send To</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control send-email-form" id="ip-send-email-send-to" placeholder="Email , Email , Email">
                        <small class="ip-notice">use comma to split mutiple email address</small>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label class="col-sm-2 col-form-label">CC</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control send-email-form" id="ip-send-email-cc" placeholder="Email , Email , Email">
                        <small class="ip-notice">use comma to split mutiple email address</small>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label class="col-sm-2 col-form-label">BCC</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control send-email-form" id="ip-send-email-bcc" placeholder="Email , Email , Email">
                        <small class="ip-notice">use comma to split mutiple email address</small>
                    </div>
                </div>
                <hr>
                <div class="mb-3 row">
                    <label class="col-sm-2 col-form-label">Subject</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control send-email-form" id="ip-send-email-subject">
                    </div>
                </div>
                <div class="mb-3 row">
                    <label class="col-sm-2 col-form-label">Attachment</label>
                    <div class="col-sm-10 d-flex flex-row">
                        <div class="p-2">
                            <label for="ipfl-attachment" class="btn btn-primary">Add</label>
                            <input class="send-email-form hiden" id="ipfl-attachment" type="file" multiple>
                        </div>
                        <div class="p-2 form-control" id="div-attachment-name">No Attachment</div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Content</label>
                    <textarea class="form-control send-email-form" id="ipta-send-email-content"></textarea>
                </div>
                <div class="div-act-btn">
                    <button type="button" class="btn btn-secondary" id="actbtn-reset">Reset</button>
                    <button type="button" class="btn btn-primary" id="actbtn-send">Send</button>
                    <button class="btn btn-primary hiden" id="actbtn-send-sending" type="button" disabled>
                        <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                        Sending...
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- load panel -->
    <div id="block-palen"></div>
    <!-- end load panel -->
    <!-- pop up act-res-modal -->
    <div id="act-res" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="act-res-modal-title" class="modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="act-res-modal-content" class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- end pop up mact-res-odal -->
    <script>
        var attachmentFles = [];
        // changing tab
        $('.tab-link').click(function () {
            $('.tab-link').removeClass('active');
            $(this).addClass('active');
            if ($(this).attr('name') === 'configuration') {
                $('.session').removeClass('active-session');
                $('#session-configuration').addClass('active-session');
            } else if ($(this).attr('name') === 'send-email') {
                $('.session').removeClass('active-session');
                $('#session-send-email').addClass('active-session');
            }
        });
        // auth on/off
        $('#ipsw-auth').change(function () {
            bootstrapSwitchChangeLabel(this, 'On', 'Off');
            if ($(this).prop('checked')) {
                $('#auth-info').removeClass('hiden');
            } else {
                $('#auth-info').addClass('hiden');
                $('#ip-auth-username,#ip-auth-password').val(null);
            }
        });
        // clear mail server config
        $('#actbtn-config-clear').click(function () {
            if (confirm('want to reset configuration?')) {
                $('.config-form').val(null);
                $('#ipcb-encryption-none').prop('checked', true);
                $('#ipsw-auth').prop('checked', false);
                $('#auth-info').addClass('hiden');
                $('#send-email-tab').addClass('hiden');
            }
        });
        // config-form change remove class is-invalid
        $('.config-form,#ipcb-encryption-none,#ipsw-auth').change(function () {
            $('#send-email-tab').addClass('hiden');
            $('.config-form').removeClass('is-invalid');
        });
        // on config page done click
        $('#actbtn-config-done').click(function () {
            $('#ip-send-from').val($('#ip-send-from').val().replaceAll(' ',''));
            $('#ip-reply-to').val($('#ip-reply-to').val().replaceAll(' ',''));
            let pass = true; let msgs = [];
            if ($('#ip-host').val() === '') {
                msgs.push('host is required');
                $('#ip-host').addClass('is-invalid');
                pass = false;
            }
            if ($('#ip-port').val() === '') {
                msgs.push('port is required');
                $('#ip-port').addClass('is-invalid');
                pass = false;
            } else if (isNaN($('#ip-port').val())) {
                msgs.push('port is only number');
                $('#ip-port').addClass('is-invalid');
                pass = false;
            }
            if($('#ipsw-auth').prop('checked')){
                if($('#ip-auth-username').val() === ''){
                    msgs.push('when authentication is on username is required');
                    $('#ip-auth-username').addClass('is-invalid');
                    pass = false;
                }
                if($('#ip-auth-password').val() === ''){
                    msgs.push('when authentication is on password is required');
                    $('#ip-auth-password').addClass('is-invalid');
                    pass = false;
                }
            }
            if ($('#ip-send-from').val() === '') {
                msgs.push('send from is required');
                $('#ip-send-from').addClass('is-invalid');
                pass = false;
            }else if(!isValidEmail($('#ip-send-from').val())){
                msgs.push('invalid email address \''+$('#ip-send-from').val()+'\' in send from');
                $('#ip-send-from').addClass('is-invalid');
                pass = false;
            }
            if($('#ip-reply-to').val() !== ''){
                if(!isValidEmail($('#ip-reply-to').val())){
                    msgs.push('invalid email address \''+$('#ip-reply-to').val()+'\' in reply to');
                    $('#ip-reply-to').addClass('is-invalid');
                    pass = false;
                }
            }
            if(pass){
                $('#send-email-tab').removeClass('hiden');
                $('#send-email-tab a').trigger('click');
            } else {
                $('#act-res-modal-title').html('Error');
                let op = '<ul>';
                msgs.forEach(function(msg){
                    op += '<li>'+msg+'</li>';
                });
                op += '</ul>';
                $('#act-res-modal-content').html(op);
                new bootstrap.Modal(document.getElementById('act-res')).show();
            }
        });
        // on add attachment file
        $('#ipfl-attachment').change(function () {
            const files = $(this).prop('files');
            for (let i = 0; i < files.length; i++) {
                attachmentFles.push(files[i]);
            }
            $(this).val(null);
            loadAttachmentName();
        });
        // load array then display attachment file name 
        function loadAttachmentName() {
            if(attachmentFles.length > 0){
                let op = '';
                for (let i = 0; i < attachmentFles.length; i++) {
                    op += '<label class="attachment-name">' + attachmentFles[i].name + '&nbsp;('+formatBytes(attachmentFles[i].size)+')&nbsp;<small onclick="removeFile(' + i + ')" class="cp-pointer">X</small></label>';
                }
                $('#div-attachment-name').html(op);
            }else{
                $('#div-attachment-name').html('No Attachment');
            }
        }
        // remove selected attachment file
        function removeFile(index) {
            attachmentFles.splice(index, 1);
            removeSendFromisInvalisClass();
            loadAttachmentName();
        }
        // reset send email page
        function sendEmailReset() {
            $('.send-email-form').val(null);
            $('#div-attachment-name').html('No Attachment');
            removeSendFromisInvalisClass();
            attachmentFles = [];
        }
        // when send email page reset click
        $('#actbtn-reset').click(function(){
            if (confirm('want to reset email?')) {
                sendEmailReset();
            }
        });
        function removeSendFromisInvalisClass(){
            $('.send-email-form,#div-attachment-name').removeClass('is-invalid');
        }
        // when send-from change remove class is-invalid
        $('.send-email-form').change(removeSendFromisInvalisClass);
        // send email page send click
        $('#actbtn-send').click(function () {
            $('#ip-send-email-send-to').val($('#ip-send-email-send-to').val().replaceAll(' ',''));
            $('#ip-send-email-cc').val($('#ip-send-email-cc').val().replaceAll(' ',''));
            $('#ip-send-email-bcc').val($('#ip-send-email-bcc').val().replaceAll(' ',''));
            let pass = true;let msgs = [];
            if($('#ip-send-email-send-to').val() === ''){
                msgs.push('send to is required');
                $('#ip-send-email-send-to').addClass('is-invalid');
                pass = false;
            }else{
                const emails = $('#ip-send-email-send-to').val().split(',');
                emails.forEach(function(email){
                    if(email !== '' && !isValidEmail(email)){
                        msgs.push('invalid email addrss \''+email+'\' in send to');
                        $('#ip-send-email-send-to').addClass('is-invalid');
                        pass = false;
                    }
                });
            }
            if($('#ip-send-email-cc').val() !== ''){
                const emails = $('#ip-send-email-cc').val().split(',');
                emails.forEach(function(email){
                    if(email !== '' && !isValidEmail(email)){
                        msgs.push('invalid email addrss \''+email+'\' in cc');
                        $('#ip-send-email-cc').addClass('is-invalid');
                        pass = false;
                    }
                });
            }
            if($('#ip-send-email-bcc').val() !== ''){
                const emails = $('#ip-send-email-bcc').val().split(',');
                emails.forEach(function(email){
                    if(email !== '' && !isValidEmail(email)){
                        msgs.push('invalid email addrss \''+email+'\' in bcc');
                        $('#ip-send-email-bcc').addClass('is-invalid');
                        pass = false;
                    }
                });
            }
            if($('#ipta-send-email-content').val() === ''){
                msgs.push('content is required');
                $('#ipta-send-email-content').addClass('is-invalid');
                pass = false;
            }
            if(attachmentFles.length > 0){
                let totalFileSize = 0;
                attachmentFles.forEach(function(file){
                    totalFileSize += file['size'];
                });
                if(totalFileSize > 31457280){
                    msgs.push('total of attachment size is '+formatBytes(totalFileSize)+' max allowed is 30MB');
                    $('#div-attachment-name').addClass('is-invalid');
                    pass = false;
                }
            }
            if(pass){
                $('#actbtn-send').hide();
                $('#block-palen,#actbtn-send-sending').show();
                const formData = new FormData();
                formData.append('host',$('#ip-host').val());
                formData.append('port',$('#ip-port').val());
                formData.append('encryption',$('input[name="ipcb-encryption"]:checked').val());
                if($('#ipsw-auth').prop('checked')){
                    formData.append('auth',1);
                    formData.append('username',$('#ip-auth-username').val());
                    formData.append('password',$('#ip-auth-password').val());
                }
                formData.append('send_from[address]',$('#ip-send-from').val());
                if($('#ip-send-from-name').val() !== ''){
                    formData.append('send_from[name]',$('#ip-send-from-name').val());
                }
                if($('#ip-reply-to').val() !== ''){
                    formData.append('reply_to[address]',$('#ip-reply-to').val());
                    if($('#ip-reply-to-name').val() !== ''){
                        formData.append('reply_to[name]',$('#ip-reply-to-name').val());
                    }
                }
                const sendTo = $('#ip-send-email-send-to').val().split(',');
                sendTo.forEach(function(email){
                    formData.append('send_to[]',email);
                });
                if($('#ip-send-email-cc').val() !== ''){
                    const cc = $('#ip-send-email-cc').val().split(',');
                    cc.forEach(function(email){
                        formData.append('cc[]',email);
                    });
                }
                if($('#ip-send-email-bcc').val() !== ''){
                    const cc = $('#ip-send-email-bcc').val().split(',');
                    cc.forEach(function(email){
                        formData.append('bcc[]',email);
                    });
                }
                if($('#ip-send-email-subject').val() !== ''){
                    formData.append("subject",$('#ip-send-email-subject').val());
                }
                formData.append("content",$('#ipta-send-email-content').val());
                if(attachmentFles.length > 0){
                    attachmentFles.forEach(function(attachmentFle){
                        formData.append("attachments[]", attachmentFle);
                    });
                }
                var settings = {
                "url": "send-email.php",
                "method": "POST",
                "timeout": 60000,
                "processData": false,
                "mimeType": "multipart/form-data",
                "contentType": false,
                "data": formData
                };
                $.ajax(settings)
                .done(function(response){
                    const res = $.parseJSON(response);
                    let op = '<ul>';
                    if(res['success']){
                        $('#act-res-modal-title').html('Success');
                        sendEmailReset();
                    }else{
                        $('#act-res-modal-title').html('Error');
                    }
                    res['message'].forEach(function(msg){
                        op += '<li>'+msg+'</li>';
                    });
                    op += '</ul>';
                    $('#act-res-modal-content').html(op);
                    new bootstrap.Modal(document.getElementById('act-res')).show();
                })
                .fail(function(jqXHR,textStatus){
                    $('#act-res-modal-title').html('Error');
                    $('#act-res-modal-content').html('<ul><li>'+textStatus+'</li></ul>');
                    new bootstrap.Modal(document.getElementById('act-res')).show();
                })
                .always(function() {
                    $('#block-palen,#actbtn-send-sending').hide();
                    $('#actbtn-send').show();
                });
            }else{
                $('#act-res-modal-title').html('Error');
                let op = '<ul>';
                msgs.forEach(function(msg){
                    op += '<li>'+msg+'</li>';
                });
                op += '</ul>';
                $('#act-res-modal-content').html(op);
                new bootstrap.Modal(document.getElementById('act-res')).show();
            }
        });
    </script>
    <style>
        * {
            margin: 0px;
            padding: 0px;
        }
        .nav-tabs {
            margin: 0px 10px;
        }
        #session {
            margin: 0px 5px;
            border: solid #e8e8e8 1px;
            border-radius: 5px;
        }
        .session {
            margin: 10px;
            display: none;
        }
        .active-session {
            display: block;
        }
        .hiden {
            display: none;
        }
        .cp-pointer {
            cursor: pointer;
        }
        #ipta-send-email-content {
            height: 210px;
        }
        .div-act-btn {
            width: 100%;
            display: flex;
            justify-content: space-between;
        }
        .attachment-name {
            border: solid 1px #d4d5d6;
            border-radius: 10px;
            padding: 0px 5px;
            margin: 1px;
            display: inline-block;
            color: #4a4a4a;
        }
        #div-attachment-name{
            color: #a3a2a2;
        }
        .attachment-name small {
            color: #a3a2a2;
        }
        .attachment-name small:hover {
            color: #cccccc;
        }
        .ip-notice{
            color: #757575;
            font-size: 10px;
        }
        #block-palen{
            position: absolute;
            top: 0px;
            width: 100%;
            height: 100%;
            background-color: transparent;
            display: none;
        }
    </style>
</body>

</html>